# Практическое задание №4

## Inline режим и состояния

### Описание задания

- Добавьте кэширование информации о доступных валютах. Можно воспользоваться встроенным декоратором [`lru_cache`](https://docs.python.org/3/library/functools.html#functools.lru_cache), либо написать своё. Учитывайте, что данные могут измениться, поэтому кэш должен переставать быть актуальным по каким-то критериям (например, дата);
- Перенесите формирование ответа на любой inline запрос в модуль `messages`
- Подготовьте установку выбранной локальной валюты командой `set_local_currency` (для дальнейшего использования при конвертации в inline запросе)
  - Добавьте функцию `set_selected_currency`, которая нужна для универсальности: перенесите в неё тело обработчика установки выбранной целевой валюты. Функция должна принимать следующие параметры:
    - `message` - сообщение, чтобы бот мог вытащить оттуда параметры команды, а также ответить пользователю;
    - `data_key` - ключ, по которому необходимо сохранить значение в состояние;
    - `set_currency_success_message` - текст сообщения об успешной установки выбранной валюты;
  - Добавьте команду `set_local_currency` в текст `help` и в `bot commands`, которые устанавливаются при старте (актуализируйте список команд для установки ботом);
  - Добавьте служебные сообщения для обработки команды установки локальной валюты (ошибка, успех) по аналогии с установкой целевой валюты; 
  - Обработайте команду `set_local_currency`, создайте отдельные обработчики:
    - При запросе на установку локальной валюты отвечайте пользователю, что установка доступна только в личных сообщениях с ботом. Так как при inline запросе вам неизвестен текущий чат, бот не сможет вытащить данные для выбранного чата. Нужно получать информацию из состояния, установленного в личных сообщениях;
    - При запросе на установку локальной валюты без указания валюты отвечайте по аналогии с установкой выбранной целевой валюты (что необходимо указать валюту);
    - При успешном запросе выполняйте обработку через функцию `set_selected_currency`;
- Добавьте в обработку inline запроса выбор локальной валюты из состояния, если она указана (по аналогии с целевой валютой);
- Добавьте новый обработчик inline запроса, где после суммы указана исходная валюта, которую нужно конвертировать, например `@MyBot 1000 IDR`;
- Добавьте новый обработчик inline запроса, где после суммы указаны исходная и целевая валюта, верните результат в соответствии с запросом, например `@MyBot 1000 IDR INR`;

### Подсказки
Если бот не получает обновления inline query, попробуйте указать `allowed_updates=[]` в [метод `infinity_polling`](https://pytba.readthedocs.io/ru/latest/sync_version/index.html#telebot.TeleBot.infinity_polling).

[Поле `allowed_updates` в методе `getUpdates`](https://core.telegram.org/bots/api#getupdates:~:text=testing%20purposes%20only.-,allowed_updates,-Array%20of%20String).

### Ссылки
- Фреймворк pyTelegramBotAPI на GitHub: https://github.com/eternnoir/pyTelegramBotAPI/
- [Метод `infinity_polling`](https://pytba.readthedocs.io/ru/latest/sync_version/index.html#telebot.TeleBot.infinity_polling)
- [Поле `allowed_updates` в методе `getUpdates`](https://core.telegram.org/bots/api#getupdates:~:text=testing%20purposes%20only.-,allowed_updates,-Array%20of%20String)
